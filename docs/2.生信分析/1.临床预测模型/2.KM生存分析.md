---
title: KM生存分析
createTime: 2025/01/13 15:22:31
permalink: /article/clinical-prediction-model/Kaplan-Meier/

tags:
  - R语言
  - 生信分析
  - 生存分析
  - KM曲线
  - 资源列表
  - 学习代码
  - 总结

# cover: 绝对地址或远程地址, 使用 绝对路径时，从 .vuepress/public 目录中加载图片
# cover: 
cover: "https://pic4.zhimg.com/v2-d0ce4e07de0a8762bbc62ee23b29e924_r.jpg"
# draft: true
# sticky: 100000
---
描述生存分析的基本概念，KM生存分析基础代码。
<!-- more -->

![](https://pic4.zhimg.com/v2-d0ce4e07de0a8762bbc62ee23b29e924_r.jpg")

## **主要参考资料**

- <Badge type="danger" text="推荐" />[STHDA](https://www.sthda.com/english/wiki/survival-analysis-basics)
## **导言**
<card>

- [X] 生存分析对应于一组统计方法，**用于调查感兴趣事件发生所需的时间**

- [X] 生存分析用于各种领域，例如：
- - 患者生存时间分析的癌症研究
- - 社会学的“事件历史分析”
- - 在工程学中，用于“失效时间分析”

- [X] 在癌症研究中，典型的研究问题有：
- - 某些临床特征对患者生存有何影响？
- - 患者存活 3 年的概率是多大？
- - 不同患者组之间的生存率是否存在差异？
</card>

## **基本概念**
<card>
临床医学研究中，大多数生存分析使用以下方法：

- **Kaplan-Meier Plots**: 可视化 Kaplan-Meier生存曲线
- **对数秩检验(Log-rank test)**： 比较两组或多组的生存曲线
- **Cox比例风险回归（Cox proportional hazards regression）**：描述变量对生存的影响
</card>

### **生存分析的基本术语**
- 生存时间和事件
- 删失
- 生存函数和危险函数

::: info 生存事件和事件
临床医学研究中的生存时间和事件类型：

- 复发
- 进展
- 死亡

癌症研究中最重要的两个指标：i）**死亡时间**; ii）**无复发生存时间**

对应于对治疗的反应和疾病复发之间的时间。也被称为`无病生存时间`(disease-free survival time)和`无事件生存时间`(event-free survival time)
:::


::: info 删失

- 生存分析侧重于发生相关事件（复发或死亡）之前的预期持续时间。
- 但是，在研究时间段内，某些个体可能无法观察到该事件，从而产生所谓的删失观察。

-[X] 删失可能通过以下方式出现：
- - 患者在研究时间段内（尚未）经历过感兴趣的事件，例如复发或死亡;
- - 患者在研究期间失访;
- - 患者经历不同的事件，导致无法进一步随访。

在生存分析中这种类型的删失称为**右删失**。
:::

::: info 生存函数和危险函数

- 两个相关的概率用于描述生存数据：**生存概率**和**风险概率**。

- 生存概率，也称为幸存者函数S(t)：是一个个体从时间起源（例如癌症诊断）存活到指定的未来时间 t 的概率
- 危险概率：h(t)，是在时间t处于观察状态的个体在该时间发生事件的概率。
:::

### **Kaplan-Meier 生存估计**

- Kaplan-Meier （KM） 方法是一种**非参数方法**，用于根据观察到的生存时间估计生存概率（Kaplan 和 Meier，1958）

- KM 生存曲线是 KM 生存概率随时间变化的图，提供了可用于估计中位生存时间等度量的有用信息


## **示例练习**

### **安装并加载所需的 R 软件包**
::: info 两个 R 包

- `survival` 用于计算生存分析的生存率
- `survminer` 用于总结和可视化生存分析的结果
:::

```R
# 安装包(安装了忽略)
install.packages(c("survival", "survminer"))

# 加载包
library("survival")
library("survminer")
```
### **示例数据集**
- 使用生存包中提供的肺癌数据
- 查看数据

```R
lung

head(lung)
str(lung)
summary(lung)
```
::: info lung数据集中变量含义

- `inst`： 机构代码
- `time`：生存时间（天）
- `status`：状态 1=存活(右删失)，2=死亡
- `age`： 年龄（岁）
- `sex`： 1 = 男, 2 = 女
- `ph.ecog`：ECOG体能评分（0 = good, 5 = dead）
- `ph.karno`：医生评分 Karnofsky 表现评分 （差 = 0-好 = 100）
- `pat.karno`：患者评分的 Karnofsky 表现评分
- `meal.cal`：进餐时消耗的卡路里
- `wt.loss`： 最近六个月的体重减轻
:::

### **计算生存曲线**
- [X] `survfit()` 函数用于计算 kaplan-Meier 生存估计
- - 使用函数 `Surv()` 创建的生存对象
- - 包含变量的数据集

```R
# 用示例数据集 lung 计算生存曲线
# 按性别(sex)计算生存概率

fit <- survfit(Surv(time, status) ~ sex, data = lung)
print(fit)
```
- [X] 显示生存曲线的更完整摘要
```R
# 生存曲线数据摘要
summary(fit)

# 生存曲线数据摘要表格
summary(fit)$table
```

### **查看`survfit()`结果详情**

::: info survfit()函数返回变量列表

- `n`：每条曲线中的个体总数。
- `time`：曲线上的时间点。
- `n.risk`：在时间 t 处于风险中的个体数
- `n.event`：在时间 t 发生的事件数。
- `n.censor`：在时间 t 退出风险集且没有事件的删失对象数。
- `lower`，`upper`：曲线的置信度下限和置信上限。
- `strata`：表示曲线估计的分组。如果 strata 不为 NULL，则结果中存在多条曲线。分组的级别 （一个因子） 是曲线的标签
:::


### **可视化生存曲线**
```R
ggsurvplot(
   fit,                     # survfit object with calculated statistics.
   pval = TRUE,             # show p-value of log-rank test.
   conf.int = TRUE,         # show confidence intervals for 
                            # point estimaes of survival curves.
   conf.int.style = "step",  # customize style of confidence intervals
   xlab = "Time in days",   # customize X axis label.
   break.time.by = 200,     # break X axis in time intervals by 200.
   ggtheme = theme_light(), # customize plot and risk table with a theme.
   risk.table = "abs_pct",  # absolute number and percentage at risk.
  risk.table.y.text.col = T,# colour risk table text annotations.
  risk.table.y.text = FALSE,# show bars instead of names in text annotations
                            # in legend of risk table.
  ncensor.plot = TRUE,      # plot the number of censored subjects at time t
  surv.median.line = "hv",  # add the median survival pointer.
  legend.labs = 
    c("Male", "Female"),    # change legend labels.
  palette = 
    c("#E7B800", "#2E9FDF") # custom color palettes.
)
```

::: info Kaplan-Meier 图解释

- 横轴（x 轴）表示以天为单位的时间，
- 纵轴（y 轴）表示生存概率或生存人数的比例。
- 线条代表两组的生存曲线。
- 曲线中的垂直下降表示事件。
- 曲线上的垂直刻度线表示此时患者被审查。
  - 在时间 0 时，生存概率为 1.0（或 100% 的参与者还活着）
  - 在时间 250 时，性别=1 的生存概率约为 0.55（或 55%），性别=2 的生存概率约为 0.75（或 75%）。
  - 性别=1 的中位生存期约为 270 天，性别=2 的中位生存期约为 426 天，表明与性别=1 相比，性别=2 的生存期较好

:::

- **每组的中位生存时间**: 每组参与者生存概率 S(t) 为 0.5 的进展时间
```R
summary(fit)$table
as.data.frame(summary(fit)$table)$median
as.data.frame(summary(fit)$table)$median[1]
as.data.frame(summary(fit)$table)$median[2]
```

::: info 统计意义

- 性别=1（男性组）的中位生存时间为 270 天，而性别=2（女性）的中位生存时间为 426 天。
- 与男性相比，女性肺癌患者似乎具有生存优势。
- 但是，要评估这种差异是否具有统计意义，需要正式的统计检验，
::: 

::: warning

- 曲线尾部的置信限很宽，这使得有意义的解释变得困难。
- 这可以通过以下事实来解释：在实践中，通常有患者在随访中失访或在随访结束时还活着。
- 因此，在 x 轴的随访结束之前缩短绘图可能是明智的（Pocock et al， 2002）
:::

- **可以使用参数 xlim 缩短生存曲线**
```R
ggsurvplot(fit,
          conf.int = TRUE,
          risk.table.col = "strata", # Change risk table color by groups
          ggtheme = theme_bw(), # Change ggplot2 theme
          palette = c("#E7B800", "#2E9FDF"),
          xlim = c(0, 600))
```

::: warning  可以使用参数 fun 指定三种常用的转换

- `log`: 幸存者函数的对数转换
- `event`: 绘制累积事件 （f（y） = 1-y）, 也被称为累积发生率，
- `cumhaz`: 绘制累积风险函数 （f（y） = -log（y））
:::

- **要绘制累积事件**
```R
ggsurvplot(fit,
          conf.int = TRUE,
          risk.table.col = "strata", # Change risk table color by groups
          ggtheme = theme_bw(), # Change ggplot2 theme
          palette = c("#E7B800", "#2E9FDF"),
          fun = "event")
```
- **绘制累积危险度**

```R
ggsurvplot(fit,
          conf.int = TRUE,
          risk.table.col = "strata", # Change risk table color by groups
          ggtheme = theme_bw(), # Change ggplot2 theme
          palette = c("#E7B800", "#2E9FDF"),
          fun = "cumhaz")
```

### KM生存曲线结果概要 
::: caution surv_summary() 函数
- 获取生存曲线的摘要
- surv_summary() 会创建一个数据框, 包含来自 survfit 结果的摘要
- 生存曲线拟合了一个或多个变量的情况下，surv_summary对象包含表示变量的额外列。这使得可以按层或某些因子组合对 ggsurvplot 的输出进行分面
- surv_summary对象还具有一个名为“table”的属性，其中包含有关生存曲线的信息，包括生存中位数和置信区间，以及每条曲线中的主体总数和事件数。
:::

```R
res.sum <- surv_summary(fit)
head(res.sum)

# 访问属性 'table'
attr(res.sum, "table")
```

### 比较生存曲线的 Log-Rank 检验

::: caution Log-Rank 检验 survdiff()函数
- 对数秩检验是比较两条或多条生存曲线的最广泛使用的方法。
- 原假设是两组之间的生存率没有差异。
- 对数秩检验是一种非参数检验，它不对生存分布做出任何假设。
- 从本质上讲，对数秩检验将每组中观察到的事件数与原假设为真（即，如果生存曲线相同）时的预期值进行比较。
- 对数秩统计是卡方检验统计的近似分布
:::

```R
surv_diff <- survdiff(Surv(time, status) ~ sex, data = lung)
surv_diff
```

::: info survdiff()函数返回值列表
- n：每组中的 Subject数。
- obs：每组中的事件加权数量。
- exp：每组的加权预期事件数。
- chisq：相等检验的卡方统计量。
- strata：（可选）每个层中包含的个体数。
:::

::: info R中小数点位数设置
- 使用round()函数进行四舍五入
- 使用trunc()函数进行截取
- 使用sprintf()函数进行格式化
- 全局设置小数点位数 `options(digits = 2)`
:::

::: tip
```R
options(digits = 4)
surv_diff$pvalue
```
- 生存率差异的对数秩检验给出 p 值 p = 0.001311，表明性别组的生存率差异显著。
:::

### 批量KM生存曲线

- 将通过多个因素的组合对 ggsurvplot（） 的输出进行分面
- 使用示例数据 colon 结肠数据集

::: tabs
@tab 生存曲线拟合
```R
library(survival)

fit2 <- survfit( Surv(time, status) ~ sex + rx + adhere,
                data = colon )
```

@tab 可视化输出
```R
library(survminer)

# Plot survival curves by sex and facet by rx and adhere
ggsurv <- ggsurvplot(fit2, fun = "event", conf.int = TRUE,
                     ggtheme = theme_bw())
   
ggsurv$plot +theme_bw() + 
  theme (legend.position = "right")+
  facet_grid(rx ~ adhere)

```

:::


## 代码分解

依赖包

```R
# 没有安装R包就先安装

# install.packages("survminer") # 安装survminer包
# install.packages("survival") # 安装survival包

# 加载包
library(survival) # 加载包
library(survminer) # 加载包

```
### 单因素KM曲线
:::tabs#单因素KM曲线

@tab 查看数据

使用survival包内置的lung数据集进行演示

<Card title="lung数据集：NCCTG晚期肺癌患者的生存率">

inst # 机构代码；

time # 生存天数；

status # 生存状态，1为删失，2为死亡；

age # 年龄；

sex # 性别，1为男性，2为女性；

ph.ecog、ph.karno、pat.karno # 为病人和患者评分，这里用不到；

meal.cal # 进食时消耗的卡路里；

wt.loss # 最近6个月内的体重下降。

</Card>

```R
View(lung) 
str(lung)
summary(lung)
```

@tab 拟合生存曲线

- [X] **创建生存对象**
- - 在survival包中先使用Surv()函数创建生存对象，生存对象是将事件时间和删失信息合并在一起的数据结构
- - 在输出的生存对象中，带<font color=red>**"+"**</font>号的表示<font color=red>**右删失**</font>数据

```R
attach(lung) # 绑定数据集
Surv(time,status) # 创建生存对象
```


- [X] **拟合曲线**

- - 使用survfit()函数来拟合生存曲线


```R
kmfit <- survfit(
    formula = Surv(time,status) ~ sex,  # 创建生存对象 和 拟合函数
    data = lung # 数据集来源
) 

kmfit # 查看拟合曲线信息

summary(kmfit) # 查看拟合曲线详细信息

summary(kmfit)$table

d <- data.frame(time = kmfit$time,
                n.risk = kmfit$n.risk,
                n.event = kmfit$n.event,
                n.censor = kmfit$n.censor,
                surv = kmfit$surv,
                upper = kmfit$upper,
                lower = kmfit$lower
)

```
- - lung数据集中男性138例，女性90例
- - 男性和女性发生感兴趣结局事件分别有112例和53例
- - 男性和女性的中位生存时间分别为270天和426天

@tab 绘制生存曲线

```R
ggsurvplot(
    kmfit, data = lung # 基础曲线
    , surv.median.line = "hv" # 增加中位生存时间
    , conf.int = TRUE # 增加置信区间
    , pval = TRUE # 添加p值
    , risk.table = TRUE # 添加风险表
    , add.all = TRUE # 添加总患者生存曲线
    , palette = "npg" # 设置调色板 
    # 可选调色板有 "grey","npg","aaas","lancet","jco", 
    # "ucscgb","uchicago","simpsons"和"rickandmorty"
    # 默认`hue`
)
```

@tab 美化生存曲线

```R
ggsurvplot(kmfit, # 创建的拟合对象
           data = lung,  # 指定变量数据来源
           conf.int = TRUE, # 显示置信区间
           pval = TRUE, # 添加P值
           surv.median.line = "hv",  # 添加中位生存时间线
           risk.table = TRUE, # 添加风险表

           # X轴设置
           xlab = "Follow up time(d)", # 指定x轴标签
           break.x.by = 100 # 设置x轴刻度间距

           # 图例设置
           legend = c(0.8,0.75), # 指定图例位置
           legend.title = "", # 设置图例标题，这里设置不显示标题，用空格替代
           legend.labs = c("Male", "Female"), # 指定图例分组标签
)  
```

@tab 绘制累计风险曲线

```R
ggsurvplot(fit, data = lung, 
           conf.int = TRUE, # 增加置信区间
           fun = "cumhaz") # 绘制累计风险曲线
```
:::

## 关键函数：survfit()函数

```R
survfit(
    formula, 
    data, 
    weights, 
    subset, 
    na.action, 
    stype=1, 
    ctype=1, 
    id, 
    cluster, 
    istate, 
    timefix=TRUE,
    etype, 
    error,  ...
)
```
### 参数解释
- formula # 形如 Surv(time,status) ~ sex 的公式
- data # 变量来源的数据集 
- weights # 观察值的权重
- subset # 数据集的子集
- na.action # 处理缺失值的函数
- id # 识别观察对象个体的变量
- etype # 事件的类型


## 关键函数：ggsurvplot()函数
### 主要参数

```R
ggsurvplot(
    fit, data = NULL, fun = NULL, color = NULL,
    palette = NULL, linetype = 1, conf.int = FALSE, 
    pval = FALSE, pval.method = FALSE, 
    test.for.trend = FALSE, surv.median.line = "none", 
    risk.table = FALSE, cumevents = FALSE,
    cumcensor = FALSE, tables.height = 0.25, 
    group.by = NULL, facet.by = NULL, add.all = FALSE, 
    combine = FALSE, ggtheme = theme_survminer(), 
    tables.theme = ggtheme, ...)
```

- [X] fit # 拟合的生存曲线对象
- [X] data # 用来拟合生存曲线的数据集

- [X] fun  # 常用三个字符参数； 
- - "event"绘制累计风险概率图 (f(y)=1-y)
- - "cumhaz"绘制累计风险(HR)
- - "pct"绘制生存概率(用百分比表示)

- [X] color # 设置生存曲线的颜色。
- - 如果只有1条曲线，则直接设置color="blue"；
- - 如果有多条曲线，默认color="strata"，按分组为生存曲线着色；
- - 也可以自定义调色板来设置曲线颜色。

- [X] palette # 调色板
- - 默认"hue"。
- - 可选调色板有"grey","npg","aaas","lancet", 
- - "jco", "ucscgb","uchicago","simpsons"和"rickandmorty".

- [X] linetype = 1# 设置曲线线型
- - 可以按"strata"设置线型；
- - 或按数字向量c(1, 2)或按字符向量c("solid", "dashed")设置

- [X] conf.int # 逻辑词；默认FASLE；为TRUE则绘制曲线置信区间

- [X] pval = FALSE # 逻辑词；为TRUE则将统计检验计算的p值添加到图上；
- - 为数字，则直接指定P值大小，如pval = 0.03；
- - 为字符串，则添加字符串到图上，如pval = "p-value: 0.031"

- [X] pval.method  # 逻辑词，是否添加计算p值的统计方法的文本；
- - 只有当 pval = TRUE时, 才会在图上添加检验方法文本

- [X] test.for.trend # 逻辑词，默认为FALSE；
- - 为TRUE则返回趋势p值的检验，趋势检验旨在检验生存曲线的有序差异

- [X] surv.median.line # 在中位生存时间点处绘制水平或垂直线的字符向量；
- - 可用值有"none"、"hv"、"h"、"v"；其中v绘制垂直线，h绘制水平线。

- [X] risk.table = FALSE# 逻辑词，图上是否添加风险表；

- [X] "absolute" 显示处于风险中的绝对数量；
- - "percentage" 显示处于风险中的百分比数量
- - "abs_pct" 显示处于风险中的绝对数量和百分比

- [X] cumevents # 逻辑词，是否添加累积事件表
- [X] cumcensor # 逻辑词，是否添加累积删失表

- [X] tables.height = 0.25# 生存曲线图下所有生存表的高度，数值0-1之间

- [X] group.by  # 包含分组变量名称的字符向量，向量长度≤2

- [X] facet.by # 字符向量，指定绘制分面生存曲线的分组变量(应≤2)的名称

- [X] ggtheme=theme_survminer() # 设置ggplot2主题，如theme_bw()

- [X] tables.theme # 作用于生存表的ggplot2主题名称
- - 有theme_survminer、theme_cleantable()

- [X] add.all = FALSE# 逻辑词；是否添加总患者生存曲线到主生存图中


### 图标题和坐标轴标签
```R
title  # 图表标题
xlab, ylab # 分别指x轴和y轴标签
```

### 图例标题和位置
```R
legend # 指定图例位置的字符向量："top"(默认),"bottom","left","right","none"等。
# legend="none" 表示移除图例；
# 图例位置也可用数字向量c(x，y)指定，x和y的值应在0到1之间。
legend.title  # 图例标题，如legend.title = "Sex"。
legend.labs # 指定图例标签的字符向量, 替换fit中strata的名称，顺序应与strata一致。
# 如 legend.labs = c("Male","Female")
```

### 坐标轴范围、刻度间距
```R
break.time.by # 设定坐标轴刻度间距
break.x.by # 设定x轴刻度的间距，如break.x.by = 100
break.y.by # 设定y轴刻度的间距，如break.y.by = 0.2
surv.scale # 生存曲线的比例转换。允许的值为"default"或"percent"。
xlim, ylim # 指定x轴和y轴的范围，如xlim = c(0,30), ylim = c(0,1)
axes.offset # 逻辑词，默认为TRUE。为FALSE，则生存曲线图的坐标轴从原点开始。
```

### 置信区间
```R
以下只有在conf.int = TRUE时才生效
conf.int.fill # 设置置信区间填充的颜色
conf.int.style # 设置置信区间的类型，有"ribbon"(默认),"step"两种。
conf.int.alpha # 数值，指定置信区间填充颜色的透明度；
# 数值在0-1之间，0为完全透明，1为不透明。
```

### P值文本大小和位置
```R
以下只有在pval = TRUE时才生效
pval.size # 指定p值文本大小的数字，默认为 5。
pval.coord # 长度为2的数字向量，指定p值位置x、y，如pval.coord=c(x,y)。
pval.method.size # 指定检验方法 log.rank 文本的大小
pval.method.coord # 指定检验方法 log.rank 文本的坐标
log.rank.weights # 计算log-rank检验p值的权重类型的名称。
```

### 删失点
```R
censor # 逻辑词，默认为TRUE，在图上绘制删失点。
censor.shape # 数值或字符，用于指定删失点的形状；默认为"+"(3), 可选"|"(124)。
censor.size # 指定删失点形状的大小，默认为4.5。
```

### 生存表
所有生存表的常规参数。指定以下参数时，可应用于所有生存表（风险表、累积事件表和累积删失表）。
```R
tables.col # 生存曲线图下所有表的颜色，默认为"black"；
# 按strata显示则tables.col="strata".
fontsize # 指定风险表和累积事件表的字体大小。
font.family # 指定文字字体的字符向量,如font.family="Courier New".
tables.y.text # 逻辑词，默认显示生存表的y轴刻度标签；为FALSE则刻度标签被隐藏
tables.y.text.col # 逻辑词，默认FALSE；为TRUE，则表的y刻度标签将按strata着色。
tables.height # 指定所有生存表的高度，数值在0-1之间，默认为0.25.
```

### 风险表
```R
risk.table.title #  风险表的标题
risk.table.pos # 指定风险表位置的字符向量；
# 有两种，"out"在生存图外(默认)，"in"在生存图内。
risk.table.col 
risk.table.fontsize
risk.table.y.text
risk.table.y.text.col 
risk.table.height 
# 这五个和上面生存表的常规参数意义是一样的
# 但是只应用在风险表中。
```

### 累积事件表
```R
cumevents.title # 累积事件表的标题
cumevents.col
cumevents.y.text
cumevents.y.text
cumevents.height
# 这四个和上面生存表的常规参数意义是一样的
# 但是只应用于累积事件表中。
```

### 累积删失表
```R
cumcensor.title # 累积删失表的标题
cumcensor.col
cumcensor.y.text
cumcensor.y.text.col
cumcensor.height
# 这四个和上面生存表的常规参数意义是一样的
# 但是只应用于累积删失表中。

```

### 生存图高度
```R
surv.plot.height # 生存图的高度，默认为0.75；
# 当risk.table = FALSE时忽略
```

### 字体样式
```R
font.title  # 标题字体
font.subtitle  # 副标题字体
font.caption
font.x、font.y  # x轴、y轴字体
font.tickslab  # 刻度标签字体
font.legend  # 图例字体
```

用长度为3的向量分别指定大小、类型、颜色。如：
```R
font.main = c(16, "bold", "darkblue")
font.x = c(14, "italic", "red")
font.y = c(14, "bold.italic", "darkred")
font.tickslab = c(12, "plain", "darkgreen")
font.x = 14 则只改变字体的大小
font.x = "bold" 则只改变字体类型
```




