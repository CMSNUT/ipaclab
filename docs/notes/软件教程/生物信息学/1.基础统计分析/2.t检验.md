---
title: t检验
createTime: 2025/01/27 08:38:38
permalink: /tutorials/bioinfomatics/basic/t-test/
---
## 简介
::: tip t检验
- **t检验**主要适用于1组或2组的**均值**的比较，要求数据符合**正态性**和**方差齐性**。
- 在R中进行t检验非常简单，就是`t.test()`函数，不管是单样本、两样本都是这一个函数。
:::

## 单样本t检验

::: tip 单样本t检验
- 单样本t检验用于将一个样本库内的样本某一变量的平均值与已知标准（或理论/假设）平均值进行比较（μ）
```R
t.test(x, mu = 0, alternative = "two.sided")

# x：包含数据值的一个数值向量
# mu：理论平均值。默认值为0，可更改。
# alternative：备择假设。允许值为“two.sided”（默认），也可以根据需要设置为“greater”或“less”之一。
```
- `t.test()`函数的结果是**列表**，包含以下组件：

    - `statistic`：t检验统计量的值
    - `parameter`：相应自由度下的t检验统计量
    - `p.value`：检验的p值
    - `conf.int`：适合于指定备择假设的均值的置信区间。
    - `estimate`：均值（独立t检验的情况）或比较两组的均值差异（配对t检验的情况）
:::

::: info **示例**
- 使用chickwts的内置R数据集
- 检验chickwts数据中weight与理论值300克之间是否有统计学差异
:::

::: tabs 

@tab **载入数据**
```R
# 导入R内自带的chickwts数据集
library(datasets)
data(chickwts)
# 将数据存储在变量df中
df <- chickwts

# 使用head()和tail()函数检查数据，分别显示数据的前一部分和最后一部分
head(df)
#   weight      feed
# 1    179 horsebean
# 2    160 horsebean
# 3    136 horsebean
# 4    227 horsebean
# 5    217 horsebean
# 6    168 horsebean

tail(df)
#    weight   feed
# 66    352 casein
# 67    359 casein
# 68    216 casein
# 69    222 casein
# 70    283 casein
# 71    332 casein
```
@tab **统计概况**
```R
# weight的统计学概况
summary(df$weight)
# Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
#   108.0   204.5   258.0   261.3   323.5   423.0
```

@tab **数据探索**
```r
# 箱形图

# 密度图（正态性检验）

# QQ图（正态性检验）

# 
```
@tab **正态性检验**
```R
# shapiro-Wilk检验
shapiro.test(df$weight) 

# Shapiro-Wilk normality test

# data:  df$weight
# W = 0.97674, p-value = 0.2101

# 正态性检验显示，weight符合正态性分布，可以满足单样本t检验的假设条件（P>0.05）
```
@tab **单样本t检验**
```R
# t-test
# 检验小鸡的体重均值（m）是否等于理论平均值（μ）300 g
test <- t.test(df$weight, mu = 300)  # 双侧检验(默认)
test 
# One Sample t-test

# data:  df$weight
# t = -4.1757, df = 70, p-value = 8.426e-05
# alternative hypothesis: true mean is not equal to 300
# 95 percent confidence interval:
#  242.8301 279.7896
# sample estimates:
# mean of x 
#  261.3099 

# 打印p值
test$p.value
[1] 8.426247e-05

# 打印均值
test$estimate
# mean of x 
#     19.25 

# 打印可信区间
test$conf.int
[1] 242.8301 279.7896
attr(,"conf.level")
[1] 0.95


# 如果要检验小鸡的体重是否小于300克（单向测试），请输入以下内容：
t.test(df$weight, mu = 300, alternative = "less")

# 如果要检验小鸡的体重是否大于300克（单向测试），请输入以下命令：
t.test(df$weight, mu = 300, alternative = "greater")

```
结果解释:
- 检验的p值为8.4e-05，小于显着性水平alpha = 0.05。
- 可以得出结论，小鸡的平均体重与300克的显着不同，p值= 8.4e-05。
:::

## **配对样本t检验**

::: tip 配对样本t检验
- 研究**两组不同变量**的观测值的均值差异.
- 配对样本t检验研究的不是两组观测值总体均值的差异，而是**同一样本**的**不同变量**观测值之间的差异。
- 比较**两个相关群体**的平均数/平均值和标准差，以确定两组之间是否存在显著差异
- 三种配对设计:

(1) **同一**受试对象接受**一种处理前后**的差异;

(2) **两同质**受试对象接受**两种不同处理**的差异:

(3) **同一**受试对象接受**两种不同处理**的差异。

- 使用配对样本t检验，需要满足5个条件：

    - 条件1：观察变量为连续变量。

    - 条件2：观察变量为配对设计。

    - 条件3：观察变量可分为2组，本研究中分为A方法和B方法两组，该条件满足。

    - 条件4：观察变量不存在显著的异常值。

    - 条件5：两个配对组别间观察变量的差值服从正态(或近似正态)分布。**如不满足则用`Wilcoxon`符号秩和检验。**
:::

:::tabs
@tab 1.载入数据
```R
# 组A
before <-c(15.4,25.3,25.6,34.7,28.8,18.9,30.0,36.7,25.8,27.7)

# 组B
after <-c(32.5,23.4,36.7,35.7,38.7,32.5,32.4,37.0,26.7,30.0)
```
@tab 2.描述两组数据
- 描述两组数据的基本情况(条件4，异常值判断)
```R
#描述组A方法的基本情况
summary(before) 

#描述组B方法的基本情况
summary(after) 

# 描述性分析R包: psych

if (!require(psych)) install.packages("psych")

library(psych)  #调用程序包“psych”
describe(before)  #描述before组的集中和离散趋势
describe(after)  #描述after组的集中和离散趋势

```
@tab 3.缺失值情况
- 条件4，异常值判断
```R
is.na(before)  #查看A方法是否存在缺失值

is.na(after)  #查看B方法是否存在缺失值

#如未发现需要删除的异常值，则进行条件5(正态性检验)的判断
```
@tab 正态性检验
- 绘制Q-Q图
```R
d <- before - after  #计算两组间差值

qqnorm(d)  #绘制Q-Q图

qqline(d)  #增加趋势线

# 若Q-Q图上散点基本围绕对角线分布，则表明数据呈正态分布
```
- shapiro-Wilk正态性检验
```R
shapiro.test(d) 

# Shapiro-Wilk normality test

# data:  d
# W = 0.87497, p-value = 0.1142

```

- 从输出中，p值大于显着性水平0.05，表明差值（d）的分布与正态分布没有显著差异。说明差值（d）符合正态分布，可以使用配对样本t检验。
- 若`Shapiro-Wilk normality test` (S-W正态性检验)结果显示 P=x>0.1，
- 则提示数据服从正态分布（满足条件5）, 可以进行`配对样本t检验`
- 如果数据不是正态分布的，建议使用`非参数配对样本Wilcoxon检验`


@tab 配对样本t检验
```R
res <- t.test(before,after,paired = TRUE)

# res <- t.test(before,after,paired = T,var.equal = T)

# res <- t.test(score ~ time, data = data, paired = TRUE) # 这个formula方法不能用了，R>=4.4.0 之后配对检验都不能使用公式模式

# 检验的p值为 0.024，小于显着性水平alpha = 0.05。然后我们可以否定原假设，并得出结论，治疗前小鼠的体重与治疗后小鼠的体重显著不同，p值 = 0.024。

```

@tab 绘图
```R
data <- data.frame(subject = rep(c(1:length(after)), 2),

                  time = rep(c("before", "after"), each = length(after)),

                  score = c(before, after))
# 不同组的数据要堆叠为1列

# 计算之前前后的差异
d <- with(data, score[time == "before"] - score[time == "after"])
# Shapiro-Wilk正态性检验差值是否符合正态分布
shapiro.test(d) # p-value = 0.11

print(data)

str(data)

# 使用dplyr软件包按组计算统计信息（平均值和标准差）
if (!require(dplyr)) install.packages("dplyr")

group_by(data, time) %>%
  summarise(
    count = n(),
    mean = mean(score, na.rm = TRUE),
    sd = sd(score, na.rm = TRUE)
  )


attach(data)

par(pty = "s")

#黑白箱形图

boxplot(score ~ time)

#有颜色的箱形图

boxplot(score ~ time,

        col = c("#003C67FF", "#EFC000FF"),

        main = "Title",

        xlab = "Time", ylab = "Score")
```
- 配对比较图的第2种画法: 展示**配对信息**
```R
# 提取治疗前数据
before <- subset(data,  time == "before", score, drop = TRUE)

# 提取治疗后数据
after <- subset(data,  time == "after", score, drop = TRUE)

# 画配对图
if (!require(PairedData)) install.packages("PairedData")

pd <- paired(before, after)
plot(pd, type = "profile") + theme_bw()

```
:::


::: note 笔记
- 配对样本、dplyr分组分析、配对分组boxplot绘图都需要使用长数据(各组数据堆叠为1列)
- 宽数据(各组数据在不同的列)需先转为长数据
- PairedData绘制配对图使用宽数据
:::

::: danger R的逆天更新
`res <- t.test(score ~ time, data = data, paired = TRUE)` 
 这个formula方法不能用了，R>=4.4.0 之后配对检验都不能使用公式方式

- t.test在R4.4.0及以后不再支持在公式形式中使用paired参数
- 如果R版本>=4.4.0，在公式形式中使用paired参数会报错

错误于t.test.formula(x ~ group, data = df.l, paired = T, var.equal = T): 
  cannot use 'paired' in formula method

**太无语了，好多包不能用了！！！！！！！！！！！！！！！！！！！！！！！！！！！**
:::

## 宽数据转长数据
```R
df <- data.frame(
    before = before, 
    after = after
)

# df <- data.frame(
#     before, 
#     after
# )

suppressMessages(library(tidyverse))

df.l <- df %>% pivot_longer(1:2, names_to = "group", values_to = "x")
# 数据一列是分组，另一列是数值
```

## **两样本t检验**
:::tabs
@tab 创建数据
```R
high <- c(134, 146, 106, 119, 124, 161, 107, 83, 113, 129, 97, 123)
low <- c(70, 118, 101, 85, 107, 132, 94)
```
@tab 进行正态性检验
```R
shapiro.test(high)
shapiro.test(low)
```

@tab 方差齐性检验
```R
bartlett.test(c(high, low) ~ rep(c("high", "low"), c(length(high), length(low))))
# 或
var.test(high,low)
```

@tab 双样本t检验
```R
t.test(high, low, paired = FALSE, var.equal = TRUE)
```