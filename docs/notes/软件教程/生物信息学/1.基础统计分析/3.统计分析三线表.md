---
title: 统计分析三线表
createTime: 2025/01/27 20:09:43
permalink: /tutorials/bioinfomatics/basic/statistical-table/
---

常见R包有：`compareGroups`、`tableone`、`table1`、`gtSummary`、`gt`、`gtExtras`等

## **compareGroups**

:::tip 简介
- `compareGroups`可用一句代码生成**基线资料表**、**单因素分析表**、**多因素分析表**等，可直接把结果导出为**csv**、**Excel**、**Word**、**Markdown**、**LaTeX**、**PDF**
- 官方文档的名字就叫：分组描述（Descriptives-by-groups），充分说明该包的强项就是**分组描述**，特别适合基线资料表、各类SCI中的table 1的绘制。**支持生存数据**，可以计算HR、OR、P-for-trend、多重检验的P值等。
- 主要就是3个函数: 
    - `compareGroups`：计算
    - `createTable`: 构建表格
    - `export2xxx`:导出表格
:::

### `compareGroups` 计算
:::tabs
@tab 示例数据
```R
if (!require(compareGroups)) install.packages("compareGroups")

library(compareGroups)
data("regicor")
dim(regicor)
str(regicor)
```
@tab Surv()包装数据
```R
library(survival)

regicor$tmain <- with(regicor, Surv(tocv, cv == "Yes"))
attr(regicor$tmain, "label") <- "Time to CV event or censoring"
```
@tab 分组统计变量差异
```R
# 以year为分组变量，统计各个变量的差异
# # 不要id这个变量

compareGroups(year ~ . - id, data=regicor)

```
:::tip **结果解释**
- 第一个变量`age`，使用的`方差分析`，给出了`age`在不同`year`中的`pvalue`，method显示了该包把`age`这个变量看做**连续型变量**且**符合正态分布**
- 可以使用方差分析看下结果.(结果是一样的)
```R
summary(aov(age ~ year, data = regicor))
```

- `sex`变量用的`卡方检验`
```R
chisq.test(regicor$sex, regicor$year)
```
@tab 部分数据统计
- 支持使用全部数据中的一部分数据，比如只看一下`age`、`smoker`、`bmi`这3个变量在不同的`year`中的差异，并且只选择性别为女性，对于`bmi`这个变量，只选择年龄大于50岁的
```R
compareGroups(year ~ age + smoker + bmi, 
              data=regicor, 
              selec = list(bmi=age>50), 
              subset = sex=="Female")
```
@tab 连续型变量统计方法指定
```R
# 连续型变量支持选择不同的统计方法
compareGroups(year ~ age + smoker + triglyc, 
              data=regicor, 
              method = c(triglyc=NA), 
              alpha= 0.01)
```
:::tip
help(compareGroups)

- `method`：统计检验方法
    - 1：数值型变量，正态分布，
    - 2：数值型变量，非正态分布
    - 3：分类变量
    - NA：使用shapiro.test()决定是否正态分布
- `alpha`：正态性检验的阈值
- `min.dis`：所有`非因子型`向量都会被认为是连续型的，除非某个变量的取值少于5个，可通过此参数更改这个标准
- `max.ylev`：分组变量的最大组数
- `include.label`: Falase 显示列的名字，而不是label
- `simplify`：有时某个变量在某个分组中可能样本数为0，这时候要设置为`TRUE`来排除这样的亚组，因为卡方检验和Fisher精确概率法的计算不能为0
@tab 创建三线表
```R
tab <- createTable(res)
tab

# 提取P值、均值等信息
# 提取P值，方便进行校正
pvals <- getResults(tab, "p.overall")
p.adjust(pvals, method = "BH")

# 4.6.0以后的版本还增加了计算调整P值的方法，和p.adjust的方法一样，比如Bonferroni/False Discovery Rate等
tab2 <- createTable(padjustCompareGroups(res, method = "BH"))
```
:::

::: tip 展示`p.ratio`和`OR`值
- **支持计算OR值和HR值，如果是`二分类`会计算`OR值`，如果是`time-to-event`数据会计算`HR值`**
- `show.ratio = TRUE`展示`p.ratio`和`OR`值

```R
res1 <- compareGroups(cv ~ age + sex + bmi + smoker, data = regicor, ref = 1)
tab1 <- createTable(res1, show.ratio = TRUE)
tab1

tab2 <- createTable(padjustCompareGroups(res1, method = "BH"), show.ratio = TRUE)
tab2
```

- **ref**可以更改参考水平，比如`smoker`以第一个水平为参考，`sex`以第二个水平为参考
```R
res2 <- compareGroups(cv ~ age + sex + bmi + smoker, 
                      data = regicor, 
                      ref = c(smoker = 1, sex = 2))
createTable(res2, show.ratio = TRUE)
```
- `ref.no`表示，如果某个变量中有No（或者NO，no，不区分大小写）这个类别，那就以这个类别为参考，这是一个可适用于所有变量的参数
```R
res <- compareGroups(cv ~ age + sex + bmi + histhtn + txhtn, data = regicor, 
                     ref.no = "NO")
createTable(res, show.ratio = TRUE)
```
:::

::: note 结果解释
- `p.overall`是通过`t检验`计算的：(如果`不符合正态分布`是通过`Kruskall-Wallis`检验计算)
```R
t.test(age ~ cv, data = regicor)
```
- `p.ratio`和`OR值`是逻辑回归得到的
```R
aa <- glm(cv ~ age, data = regicor,family = binomial())
broom::tidy(aa,exponentiate = T,conf.int = T)
```
- `age`的`p.value`就是表格中的`p.ratio`，`estimate`是`OR值`，`conf.low`和`conf.high`是**置信区间**
:::

### `createTable` 创建表格
- `createTable`函数用于把`compareGroups`计算的结果转换为表格，打印在屏幕上或者导出为CSV、LaTeX、HTML、Word、Excel等格式

```R
res <- compareGroups(year ~ age + sex + smoker + bmi + sbp, data = regicor, 
                     selec = list(sbp = txhtn == "No"))
restab <- createTable(res)
```
- `which.table = "descr"`给出描述性三线表
```R

```


::: note 笔记
使用该R包的要点：
- 该包的重点是描述数据，不是对数据进行质量控制或其他目的。
- 强烈建议数据框中只包含需要描述的数据，对于不需要的数据建议不要包含在数据框中。
- 分类变量需要先进行**因子化**。
- 可以给各个变量增加label属性以展示其详细信息，该包默认会展示各个变量的label。
- 生存数据（time-to-event），必须使用Surv()包装数据
:::

## 参考资料
[三线表和统计绘图](https://ayueme.github.io/R_medical_stat/%E7%BB%9F%E8%AE%A1%E5%9B%BE%E8%A1%A8.html#%E7%BB%9F%E8%AE%A1%E8%A1%A8)